#!/bin/sh
#
# Pre-commit hook for Diamond
#
# This script runs multiple checks before allowing a commit:
# 1. Gitleaks - Ensures no secrets are committed
# 2. Test signature blocking - Prevents unit test code from being committed

FAILED=0

# Check 1: Gitleaks protection
command -v gitleaks >/dev/null 2>&1 || {
    echo "Error: gitleaks is not installed or not in the PATH."
    echo "Please install it (e.g., 'brew install gitleaks') to commit changes."
    exit 1
}

echo "Running gitleaks protection..."
gitleaks protect --staged --redact --verbose

if [ $? -eq 0 ]; then
    echo "✓ Gitleaks check passed."
else
    echo "
    ______________________________________________________________________
   /                                                                      \\
  |  GITLEAKS DETECTED SECRETS!                                          |
  |                                                                      |
  |  Your commit has been blocked because it contains potential secrets. |
  |  Please remove the secrets and stage the changes again.              |
  |                                                                      |
  |  If this is a false positive, you can add a comment to the line:     |
  |  # gitleaks:allow                                                    |
   \\______________________________________________________________________/
    "
    FAILED=1
fi

# Check 2: Test user commits (prevent unit test accidents)
if git diff --cached --name-only | grep -q '\.rs$'; then
    if git diff --cached | grep -E '^\+.*Test User|test@example\.com' >/dev/null 2>&1; then
        echo ""
        echo "❌ Error: Detected test user signature in staged changes"
        echo ""
        echo "   Found 'Test User' or 'test@example.com' in your commit."
        echo "   This looks like test code that should not be committed."
        echo ""
        echo "   Please review your changes and ensure you're not committing"
        echo "   test fixtures, temporary test code, or debugging changes."
        echo ""
        FAILED=1
    else
        echo "✓ Test signature check passed."
    fi
fi

exit $FAILED
